{% extends 'base.html' %}

{% block title %}
	Form Peminjaman Kendaraan
{% endblock %}

{% block content %}
<br />
<div class="row">
	<div class="col s12">
    	<h4>Form Peminjaman Baru</h4>
  	</div>
	<form action="{% url 'peminjamanCreate' %}" method="post" id="form" enctype="multipart/form-data">
		{% csrf_token %}

		<div class="row">
			<div class="col m12">
				<h5>Data Peminjam</h5>
			</div>
			<div class="input-field col s6">
	          <input id="nama_peminjam" name="nama_peminjam" type="text" class="validate">
	          <label for="nama_peminjam">Nama Peminjam*</label>
		    </div>

		    <div class="input-field col s6">
	          <input id="no_telepon_peminjam" name="no_telepon_peminjam" type="text" class="validate">
	          <label for="no_telepon_peminjam">No Telp Peminjam*</label>
		    </div>

		    <div class="input-field col s6">
	          <input id="bagian_jurusan" name="bagian_jurusan" type="text" class="validate">
	          <label for="bagian_jurusan">Bagian Jurusan*</label>
		    </div>
	   </div>

	   <div class="row">
	   		<div class="col m12">
	   			<h5>Data Kendaraan</h5>
	   		</div>
	   		<div class="input-field col s6">
		    	{% if all_mobil %}
		    		<select id="mobil_id" name="mobil_id">
		    			<option value="" disabled selected>Pilih Kendaraan</option>
						{% for mobil in all_mobil %}
							<option value="{{mobil.id}}" supir_id="{{mobil.supir_id}}">{{mobil.nama}}</option>
						{% endfor %}
					</select>
					<label>Kendaraan*</label>
				{% else %}
					<p>No Mobil are available. Please create new Mobil first in Admin panel.</p>
				{% endif %}
		    </div>
		    <div class="input-field col s6">
		    	{% if all_supir %}
		    		<select id="supir_id" name="supir_id">
		    			<option class="supir_option" value="" disabled selected>Pilih Supir</option>
						{% for supir in all_supir %}
							<option class="supir_option" value="{{supir.id}}">{{supir.nama}}</option>
						{% endfor %}
					</select>
					<label>Supir*</label>
				{% else %}
					<p>No Supir are available. Please create new Supir first in Admin panel.</p>
				{% endif %}
		    </div>
	   </div>

		<div class="row">
			<div class="col m12">
				<h5>Data Peminjaman</h5>
			</div>
			<div class="input-field col s12">
	          <input id="acara" name="acara" type="text" class="validate">
	          <label for="acara">Acara*</label>
		    </div>

		    <div class="input-field col s12">
	          <input id="tujuan" name="tujuan" type="text" class="validate">
	          <label for="tujuan">Tujuan*</label>
		    </div>

			<div class="input-field col s6">
	          <input id="tanggal_booking" name="tanggal_booking" type="date" class="datepicker">
	          <label for="tanggal_booking">Tanggal Booking*</label>
		    </div>

	     	<div class="input-field col s6">
	          <input id="tanggal_pemakaian" name="tanggal_pemakaian" type="date" class="datepicker">
	          <label for="tanggal_pemakaian">Tanggal Pemakaian*</label>
		    </div>

		    <div class="input-field col s6">
		      <span>Waktu Berangkat*</span>
	          <input id="waktu_berangkat" name="waktu_berangkat" class="timepicker">
	          <!-- <label for="waktu_berangkat">Waktu Berangkat*</label> -->
		    </div>

		    <div class="input-field col s6">
		      <span>Waktu Datang*</span>
	          <input id="waktu_datang" name="waktu_datang" class="timepicker">
	          <!-- <label for="waktu_datang">Waktu Datang*</label> -->
		    </div>

		    <div class="input-field col s6">
	          <input id="tanggal_pemakaian" name="tanggal_pengembalian" type="date" class="datepicker">
	          <label for="tanggal_pengembalian">Tanggal Pengembalian*</label>
		    </div>

		    <div class="input-field col s12">
	          <input id="tempat_berkumpul" name="tempat_berkumpul" type="text" class="validate">
	          <label for="tempat_berkumpul">Tempat Berkumpul*</label>
		    </div>

		    <div class="input-field col s12">
	          <textarea id="keterangan" name="keterangan" class="materialize-textarea"></textarea>
	          <label for="keterangan">Keterangan</label>
		    </div>

		    <div class="input-field col s6">
		    	<input name="odometer_sebelum" type="text" class="validate">
	          <label for="odometer_sebelum">Odometer Sebelum</label>
		    </div>

		    <div class="input-field col s6">
		    	<input name="odometer_sesudah" type="text" class="validate">
	          <label for="odometer_sesudah">Odometer Sesudah</label>
		    </div>
	    </div>

	    <div class="row">
	   		<div class="input-field col s6">
	          <input id="no_surat" name="no_surat" type="text" class="validate">
	          <label for="no_surat">No Surat*</label>
		    </div>

		    <div class="input-field col s6">
	          <input id="tanggal_surat" name="tanggal_surat" type="date" class="datepicker">
	          <label for="tanggal_surat">Tanggal Surat*</label>
		    </div>

		    <div class="input-field col s6">
				<select id="bukti_transfer" name="bukti_transfer">
					<option value="" disabled selected>Pilih</option>
					<option value="0">Tidak Ada</option>
					<option value="1">Ada</option>
				</select>
				<label>Ada Bukti Transfer?*</label>
		    </div>

		    <div id="foto-bukti-transfer" class="file-field input-field col s12">
		      <div class="btn" style="background-color: #1D73BE;">
		        <span>Foto Bukti Transfer</span>
		        <input type="file" name="foto_bukti_transfer" id="foto_bukti_transfer">
		      </div>
		      <div class="file-path-wrapper">
		        <input class="file-path validate" type="text">
		      </div>
		    </div>

		    <div id="foto-form-akhir" class="file-field input-field col s12">
		      <div class="btn" style="background-color: #1D73BE;">
		        <span>Foto Form Akhir</span>
		        <input type="file" name="foto_form_akhir" id="foto_form_akhir">
		      </div>
		      <div class="file-path-wrapper">
		        <input class="file-path validate" type="text">
		      </div>
		    </div>

		</div>

	</form>
	<div class="col m12">
		<p><strong id="error_message"></strong></p>
		<button class="btn waves-effect waves-light" style="background-color: #1D73BE; margin-top: 40px;" onclick="validateInput()" name="action">
			Save
		</button>
	</div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
    $('#navbar-menu-peminjaman').addClass('active')
</script>
<script type="text/javascript">
	// Initialize select
	$(document).ready(function() {
		$('select').material_select();
		$(document).ready(function(){
		    $('input.timepicker').timepicker({});
				$("#foto-bukti-transfer").hide();
		});
	});
	// Initialize date picker
	$('.datepicker').pickadate({
		selectMonths: true, // Creates a dropdown to control month
		selectYears: 15 // Creates a dropdown of 15 years to control year
	});

	$('#bukti_transfer').on('change', function () {
		var optionSelected = $("option:selected", this);
		var valueSelected = this.value;

		if(valueSelected == 1){
		   $("#foto-bukti-transfer").show();
		} else {
		   $("#foto-bukti-transfer").hide();
		}
	});

	$('#mobil_id').on('change', function() {
		var option = $('option:selected', this).attr('supir_id');
		console.log(option)
		$('#supir_id').val(option)
	   	// re-initialize material-select
	   	$('#supir_id').material_select();
	});

	function validateInput() {
		$('#error_message').text('')
		var nama_peminjam = $('#nama_peminjam').val()
		if(nama_peminjam.trim() == "") {
			console.log("Missing: nama peminjam")
			$('#nama_peminjam').focus()
			$('#error_message').text('Please input Nama Peminjam.')
			return
		}

		var no_telepon_peminjam = $('#no_telepon_peminjam').val()
		if(no_telepon_peminjam.trim() == "") {
			console.log("Missing: no telepon peminjam")
			$('#no_telepon_peminjam').focus()
			$('#error_message').text('Please input No Telepon Peminjam.')
			return
		}

		var bagian_jurusan_peminjam = $('#bagian_jurusan').val()
		if(bagian_jurusan_peminjam.trim() == "") {
			console.log("Missing: bagian jurusan peminjam")
			$('#bagian_jurusan').focus()
			$('#error_message').text('Please input Bagian Jurusan Peminjam.')
			return
		}

		// Check mobil_id
	    var mobil_id = $('#mobil_id').find(":selected").val();
	    console.log("mobil_id:"+mobil_id)
	    if(mobil_id.trim() == "") {
			$('#mobil_id').focus()
			console.log("Missing: Mobil ID")
			$('#error_message').text("Please select Kendaraan.")
			return
	    }

		// Check supir_id
	    var supir_id = $('#supir_id').find(":selected").val();
	    console.log("Supir_id:"+supir_id)
	    if(supir_id.trim() == "") {
			$('#supir_id').focus()
			console.log("Missing: Supir ID")
			$('#error_message').text("Please select Nama Supir Kendaraan.")
			return
	    }

	    var acara = $('#acara').val()
		if(acara.trim() == "") {
			console.log("Missing: acara")
			$('#acara').focus()
			$('#error_message').text('Please input Acara.')
			return
		}

		var tujuan = $('#tujuan').val()
		if(tujuan.trim() == "") {
			console.log("Missing: tujuan")
			$('#tujuan').focus()
			$('#error_message').text('Please input Tujuan.')
			return
		}

		var tanggal_booking = $('#tanggal_booking').val()
		// console.log(tanggal_booking)
		if(tanggal_booking == "") {
			console.log("Missing: tanggal_booking")
			$('#tanggal_booking').focus()
			$('#error_message').text('Please input Tanggal Booking.')
			return
		}

		var tanggal_pemakaian = $('#tanggal_pemakaian').val()
		// console.log(tanggal_pemakaian)
		if(tanggal_pemakaian == "") {
			console.log("Missing: tanggal_pemakaian")
			$('#tanggal_pemakaian').focus()
			$('#error_message').text('Please input Tanggal Pemakaian.')
			return
		}

		var tanggal_pengembalian = $('#tanggal_pengembalian').val()
		// console.log(tanggal_pengembalian)
		if(tanggal_pengembalian == "") {
			console.log("Missing: tanggal_pengembalian")
			$('#tanggal_pengembalian').focus()
			$('#error_message').text('Please input Tanggal Pengembalian.')
			return
		}

		var tempat_berkumpul = $('#tempat_berkumpul').val()
		if(tempat_berkumpul.trim() == "") {
			console.log("Missing: tempat_berkumpul")
			$('#tempat_berkumpul').focus()
			$('#error_message').text('Please input Tempat Berkumpul.')
			return
		}


		var no_surat = $('#no_surat').val()
		if(no_surat.trim() == "") {
			console.log("Missing: no_surat")
			$('#no_surat').focus()
			$('#error_message').text('Please input No Surat.')
			return
		}

		var tanggal_surat = $('#tanggal_surat').val()
		// console.log(tanggal_surat)
		if(tanggal_surat == "") {
			console.log("Missing: tanggal_surat")
			$('#tanggal_surat').focus()
			$('#error_message').text('Please input Tanggal Surat.')
			return
		}

		var bukti_transfer = $('#bukti_transfer').find(":selected").val();
	    console.log("bukti_transfer:"+bukti_transfer)
	    if(bukti_transfer.trim() == "") {
			$('#bukti_transfer').focus()
			console.log("Missing: bukti_transfer")
			$('#error_message').text("Please select Ada Bukti Transfer?.")
			return
	    }

	 	console.log(tanggal_pemakaian)
		$.post("/cek/",
	    {
	    	csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
	        date: tanggal_pemakaian,
	        mobil_id: mobil_id
	    },
	    function(data, status){
	        // alert("Data: " + data + "\nStatus: " + status);
	        if(data == "True") {
	        	$('#form').submit()
	        }
	        else {
	        	console.log("Date not OK")
				$('#error_message').text('Kendaraan is used on the selected date. Please select another Kendaraan or Tanggal Pemakaian.')
				return
	        }
	    });


	}
</script>
{% endblock %}
